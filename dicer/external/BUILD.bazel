load("@rules_scala//scala:scala.bzl", "scala_library", "scala_test")

package(
    default_visibility = ["//dicer:internal"],
)

filegroup(
    name = "all_files",
    srcs = glob(["**"]),
    visibility = ["//caching/oss:__pkg__"],
)

scala_library(
    name = "clerk",
    srcs = ["src/Clerk.scala"],
    exports = [
        ":conf",
        ":external_common",
    ],
    visibility = ["//visibility:public"],
    deps = [
        ":conf",
        ":external_common",
        "//dicer/client:clerk_impl",
        "@maven//:com_google_code_findbugs_jsr305",
    ],
)

scala_library(
    name = "conf",
    srcs = [
        "src/Conf.scala",
        "src/Target.scala",
    ],
    exports = [
        "//dicer/common:common_ssl_conf",
        "//dicer/common:internal_client_conf",
        "//dicer/common:watch_server_conf",
        "//wrappers/conf:dbconf",
        "//wrappers/conf:location",
        "//wrappers/conf:rpc-port-conf",
        "//wrappers/rpc:rpc_ssl",
        "//wrappers/rpc:rpc_tls",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "//caching/util:rfc1123",
        "//caching/util:where_am_i_helper",
        "//dicer/common:common_ssl_conf",
        "//dicer/common:internal_client_conf",
        "//dicer/common:watch_server_conf",
        "//wrappers/conf:dbconf",
        "//wrappers/conf:location",
        "//wrappers/conf:rpc-port-conf",
        "//wrappers/rpc:rpc_ssl",
        "//wrappers/rpc:rpc_tls",
    ],
)

scala_library(
    name = "slicelet_listener",
    srcs = ["src/SliceletListener.scala"],
    visibility = ["//visibility:public"],
)

scala_library(
    name = "slicelet",
    srcs = ["src/Slicelet.scala"],
    exports = [
        ":conf",
        ":external_common",
        ":slicelet_listener",
    ],
    visibility = ["//visibility:public"],
    deps = [
        ":clerk",
        ":conf",
        ":external_common",
        ":slicelet_listener",
        "//dicer/client:slicelet_impl",
        "//dicer/common:sliceset_impl",
        "//dicer/common:squid",
        "@maven//:com_google_code_findbugs_jsr305",
    ],
)

scala_library(
    name = "dicer_test_env",
    srcs = ["src/DicerTestEnvironment.scala"],
    exports = [":clerk"],
    testonly = True,
    visibility = ["//visibility:public"],
    deps = [
        ":clerk",
        ":external_common",
        ":slicelet",
        "//caching/util:assert_macros",
        "//caching/util:prefix_logger",
        "//caching/util:sequential_execution_context",
        "//caching/util:server_conf",
        "//caching/util:test_utils",
        "//caching/util:typed_clock",
        "//dicer/assigner/config:internal_target_config_map",
        "//dicer/assigner:assigner_conf",
        "//dicer/assigner:assigner_slicez",
        "//dicer/assigner:etcd_preferred_assigner_driver",
        "//dicer/assigner:interposing_preferred_assigner",
        "//dicer/assigner:preferred_assigner_driver",
        "//dicer/client:clerk_impl",
        "//dicer/client:ports",
        "//dicer/client:slicelet_impl",
        "//dicer/client:test_client",
        "//dicer/common:assignment_core",
        "//dicer/common:client_request",
        "//dicer/common:generation",
        "//dicer/common:slicekey_helper",
        "//dicer/common:squid",
        "//dicer/common:test_environment",
        "//dicer/friend:slice_map",
        "//wrappers/conf:core",
        "//wrappers/conf:project-conf",
        "//wrappers/rpc:client",
        "@com_google_protobuf_protobuf_java",
        "@maven//:com_google_guava_guava",
        "@maven//:com_typesafe_config",
        "@scala_proto_rules_grpc_api",
        "@scala_proto_rules_grpc_netty",
        "@scala_proto_rules_grpc_stub",
        "@scala_proto_rules_scalapb_runtime",
    ],
)

scala_library(
    name = "samples",
    srcs = ["test/Samples.scala"],
    testonly = True,
    visibility = ["//dicer:internal"],
    deps = [
        ":clerk",
        ":slicelet",
        "//wrappers/conf:core",
        "//wrappers/conf:project",
        "//wrappers/conf:project-conf",
        "//wrappers/logging",
        "//wrappers/rpc:client",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "@com_google_protobuf_protobuf_java",
        "@maven//:com_google_guava_guava",
        "@maven//:com_typesafe_config",
        "@scala_proto_rules_grpc_api",
        "@scala_proto_rules_grpc_netty",
        "@scala_proto_rules_grpc_stub",
        "@scala_proto_rules_scalapb_runtime",
    ],
)

scala_library(
    name = "external_common",
    srcs = [
        "src/ResourceAddress.scala",
        "src/Slice.scala",
        "src/SliceKey.scala",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "//caching/util:bytes",
        "//wrappers/rpc:rich_scalapb",
        "@com_google_protobuf_protobuf_java",
        "@maven//:com_google_guava_guava",
        "@maven//:io_prometheus_simpleclient",
        "@scala_proto_rules_grpc_api",
        "@scala_proto_rules_grpc_netty",
        "@scala_proto_rules_grpc_stub",
        "@scala_proto_rules_scalapb_runtime",
    ],
)

scala_test(
    name = "conf_suite",
    srcs = ["test/ConfSuite.scala"],
    timeout = "short",
    deps = [
        ":conf",
        "//caching/util:test_util",
        "//dicer/common:common_ssl_conf",
        "//wrappers/conf:core",
        "//wrappers/conf:project",
        "//wrappers/conf:project-conf",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "@maven//:com_typesafe_config",
    ],
)

scala_library(
    name = "clerk_suite_base",
    srcs = ["test/ClerkSuiteBase.scala"],
    testonly = True,
    deps = [
        ":clerk",
        ":clerk_driver",
        ":external_common",
        ":slicelet",
        "//caching/util:metric_utils",
        "//caching/util:sequential_execution_context",
        "//caching/util:test_util",
        "//caching/util:unix_time_version",
        "//caching/util:where_am_i_test_utils",
        "//dicer/assigner/config:internal_target_config_map",
        "//dicer/assigner:assigner_slicez",
        "//dicer/client:clerk_impl",
        "//dicer/client:test_client",
        "//dicer/common:assignment_core",
        "//dicer/common:client_type",
        "//dicer/common:common_ssl_conf",
        "//dicer/common:generation",
        "//dicer/common:squid",
        "//dicer/common:target_helper",
        "//dicer/common:test_common",
        "//dicer/common:test_environment",
        "//dicer/common:version",
        "//dicer/friend:slice_map",
        "//wrappers/conf:core",
        "//wrappers/conf:location",
        "//wrappers/conf:location_test",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "//wrappers/util:jsonutil",
        "@maven//:com_typesafe_config",
        "@maven//:io_prometheus_simpleclient",
    ],
)

scala_test(
    name = "scala_clerk_suite",
    srcs = ["test/ScalaClerkSuite.scala"],
    timeout = "short",
    deps = [
        ":clerk",
        ":clerk_driver",
        ":clerk_suite_base",
        ":external_common",
        ":slicelet",
        "//caching/util:sequential_execution_context",
        "//caching/util:test_util",
        "//caching/util:where_am_i_test_utils",
        "//dicer/client:slicelet_impl",
        "//dicer/client:test_client",
        "//dicer/common:client_type",
        "//dicer/common:test_common",
        "//dicer/common:test_environment",
        "//wrappers/conf:core",
        "//wrappers/conf:location",
        "//wrappers/conf:location_test",
        "//wrappers/conf:project",
        "//wrappers/conf:project-conf",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "@maven//:com_typesafe_config",
    ],
)

scala_test(
    name = "scala_direct_clerk_suite",
    srcs = ["test/ScalaDirectClerkSuite.scala"],
    timeout = "short",
    deps = [
        ":clerk",
        ":clerk_driver",
        ":clerk_suite_base",
        ":external_common",
        ":slicelet",
        "//caching/util:sequential_execution_context",
        "//caching/util:test_util",
        "//caching/util:where_am_i_test_utils",
        "//dicer/common:client_type",
        "//dicer/common:test_common",
        "//dicer/common:test_environment",
        "//wrappers/conf:core",
        "//wrappers/conf:location",
        "//wrappers/conf:location_test",
        "//wrappers/conf:project-conf",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "@maven//:com_typesafe_config",
    ],
)

scala_library(
    name = "clerk_driver",
    srcs = ["test/ClerkDriver.scala"],
    testonly = True,
    deps = [
        ":clerk",
        ":external_common",
        "//caching/util:test_util",
        "//dicer/client:clerk_impl",
        "//dicer/common/proto:common_proto_scala_lib",
        "//dicer/common/test/proto:test_driver_proto_scala_lib",
        "//dicer/common:target_helper",
        "@com_google_protobuf_protobuf_java",
        "@maven//:com_google_guava_guava",
        "@scala_proto_rules_grpc_api",
        "@scala_proto_rules_grpc_netty",
        "@scala_proto_rules_grpc_stub",
        "@scala_proto_rules_scalapb_runtime",
    ],
)

scala_library(
    name = "slicelet_driver",
    srcs = ["test/SliceletDriver.scala"],
    testonly = True,
    deps = [
        ":external_common",
        ":slicelet",
        "//caching/util:sequential_execution_context",
        "//caching/util:test_util",
        "//dicer/client:slicelet_impl",
        "//dicer/common/proto:common_proto_scala_lib",
        "//dicer/common/test/proto:test_driver_proto_scala_lib",
        "//dicer/common:assignment_core",
        "//dicer/common:slice_helper",
        "//dicer/common:squid",
        "//dicer/common:target_helper",
        "//dicer/friend:slicelet_accessor",
        "@com_google_protobuf_protobuf_java",
        "@maven//:com_google_guava_guava",
        "@scala_proto_rules_grpc_api",
        "@scala_proto_rules_grpc_netty",
        "@scala_proto_rules_grpc_stub",
        "@scala_proto_rules_scalapb_runtime",
    ],
)

scala_library(
    name = "slicelet_suite_base",
    srcs = ["test/SliceletSuiteBase.scala"],
    data = ["//dicer/common/test/data"],
    testonly = True,
    visibility = ["//dicer/external:__pkg__"],
    deps = [
        ":clerk",
        ":external_common",
        ":slicelet",
        ":slicelet_driver",
        ":slicelet_listener",
        "//caching/util:fake_sequential_execution_context",
        "//caching/util:lock",
        "//caching/util:metric_utils",
        "//caching/util:sequential_execution_context",
        "//caching/util:server_conf",
        "//caching/util:test_util",
        "//caching/util:unix_time_version",
        "//dicer/assigner/config:internal_target_config_map",
        "//dicer/assigner:assigner_slicez",
        "//dicer/client:clerk_impl",
        "//dicer/client:slicelet_impl",
        "//dicer/client:test_client",
        "//dicer/client:watch_address_helper",
        "//dicer/common/proto:common_proto_scala_lib",
        "//dicer/common/test/proto:test_data_proto_scala_lib",
        "//dicer/common:assignment_core",
        "//dicer/common:client_request",
        "//dicer/common:client_type",
        "//dicer/common:common_ssl_conf",
        "//dicer/common:generation",
        "//dicer/common:sliceset_impl",
        "//dicer/common:squid",
        "//dicer/common:target_helper",
        "//dicer/common:test_assigner",
        "//dicer/common:test_common",
        "//dicer/common:test_environment",
        "//dicer/common:version",
        "//dicer/friend:slice_map",
        "//wrappers/common/status:status",
        "//wrappers/conf:core",
        "//wrappers/conf:location",
        "//wrappers/conf:location_test",
        "//wrappers/conf:project",
        "//wrappers/conf:project-conf",
        "//wrappers/rpc:client",
        "//wrappers/rpc:readiness_probe_tracker",
        "//wrappers/rpc:rpc_ssl",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "//wrappers/util:jsonutil",
        "@com_google_protobuf_protobuf_java",
        "@maven//:com_google_guava_guava",
        "@maven//:com_typesafe_config",
        "@maven//:io_prometheus_simpleclient",
        "@maven//:org_scala_lang_modules_scala_collection_compat_2_12",
        "@scala_proto_rules_grpc_api",
        "@scala_proto_rules_grpc_netty",
        "@scala_proto_rules_grpc_stub",
        "@scala_proto_rules_scalapb_runtime",
    ],
)

scala_test(
    name = "slicelet_suite_local_unknown_suite",
    srcs = ["test/ScalaSliceletWithLocalUnknownClusterSuite.scala"],
    data = ["//dicer/common/test/data"],
    timeout = "moderate",
    deps = [
        ":conf",
        ":external_common",
        ":slicelet_suite_base",
        "//caching/util:test_util",
        "//dicer/client:slicelet_impl",
        "//dicer/common:test_common",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "//wrappers/util:jsonutil",
    ],
)

scala_test(
    name = "slicelet_suite_local_known_suite",
    srcs = ["test/ScalaSliceletWithLocalKnownClusterSuite.scala"],
    data = ["//dicer/common/test/data"],
    timeout = "moderate",
    deps = [
        ":conf",
        ":external_common",
        ":slicelet_suite_base",
        "//caching/util:test_util",
        "//dicer/client:slicelet_impl",
        "//dicer/common:test_common",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "//wrappers/util:jsonutil",
    ],
)

scala_test(
    name = "singleton_slicelet_suite",
    srcs = ["test/SingletonSliceletSuite.scala"],
    timeout = "short",
    deps = [
        ":slicelet",
        "//caching/util:sequential_execution_context",
        "//caching/util:test_util",
        "//dicer/assigner/config:internal_target_config_map",
        "//dicer/assigner:assigner_slicez",
        "//dicer/client:test_client",
        "//dicer/common:common_ssl_conf",
        "//dicer/common:test_common",
        "//dicer/common:test_environment",
        "//wrappers/conf:core",
        "//wrappers/conf:project",
        "//wrappers/conf:project-conf",
        "//wrappers/rpc:rpc_ssl",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "@maven//:com_typesafe_config",
    ],
)

scala_test(
    name = "dicer_test_environment_suite",
    srcs = ["test/DicerTestEnvironmentSuite.scala"],
    timeout = "short",
    deps = [
        ":clerk",
        ":dicer_test_env",
        ":samples",
        ":slicelet",
        "//caching/util:test_util",
        "//dicer/client:slicelet_impl",
        "//dicer/client:test_client",
        "//dicer/common:test_common",
        "//wrappers/conf:core",
        "//wrappers/conf:project",
        "//wrappers/conf:project-conf",
        "//wrappers/rpc:rpc_testing",
        "//wrappers/util:async_test_helpers",
        "//wrappers/util:databricks-test",
        "@maven//:com_typesafe_config",
        "@maven//:org_scala_lang_modules_scala_collection_compat_2_12",
    ],
)
